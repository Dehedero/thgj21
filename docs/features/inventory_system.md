# 3.4. Система инвентаря

Система инвентаря в GOAT — это мощный инструмент для хранения, отображения и взаимодействия с предметами. Она состоит из глобального менеджера (`goat_inventory`), UI-сцен и поддержки 3D-моделей.

## Архитектура

- **Глобальный синглтон**: `goat_inventory` управляет всеми предметами, их добавлением, удалением, выбором и использованием. Все предметы идентифицируются по уникальному имени (строка).
- **UI-сцены**:
    - `Inventory.tscn` — основное окно инвентаря с 3D-просмотром предмета.
    - `InventoryBar.tscn` — панель быстрого доступа (отображается сбоку экрана).
    - `InventoryItems.tscn` — список предметов с кнопками для выбора, использования и комбинирования.

Подробнее о структуре и кастомизации UI-инвентаря см. [Вспомогательные UI-сцены](./helper_scenes.md#inventory).

## Как добавить новый предмет в инвентарь

Система инвентаря в GOAT спроектирована так, чтобы автоматически обнаруживать и регистрировать новые предметы, если они размещены в правильных директориях и названы в соответствии с соглашениями.

1.  **Создайте 3D-модель**:
    *   Создайте или импортируйте вашу 3D-модель. Важно, чтобы это была сохраненная сцена (`.tscn`), а не просто файл модели (`.obj`, `.glb`).
    *   Поместите сцену в папку: `res://game/inventory_items/models/`.
    *   Назовите файл сцены в **PascalCase** (например, `MyAwesomeKey.tscn`).

2.  **Создайте иконку**:
    *   Создайте иконку для вашего предмета в формате `.png`.
    *   Поместите иконку в папку: `res://game/inventory_items/icons/`.
    *   Назовите файл иконки в **snake_case**, и это имя должно соответствовать имени 3D-модели (например, `my_awesome_key.png`).

3.  **Готово!**
    *   При следующем запуске игры `goat_inventory` автоматически просканирует папку `models`, обнаружит `MyAwesomeKey.tscn`, зарегистрирует предмет с именем `my_awesome_key` и свяжет его с иконкой `my_awesome_key.png`.

**Если папок `inventory_items/models` или `inventory_items/icons` не существует в директории `res://game/`, просто создайте их.**

### Автоматическая генерация иконок

Если вы предоставите модель, но не предоставите иконку, система GOAT автоматически сгенерирует иконку для вас! Она использует сцену `IconMaker.tscn`, чтобы сделать "снимок" вашей 3D-модели на прозрачном фоне. Это очень удобно для быстрой разработки.

## Основные методы и сигналы `goat_inventory`

- **Методы**:
    - `add_item(item_name: String)` — добавить предмет.
    - `remove_item(item_name: String)` — удалить предмет.
    - `replace_item(replaced_item_name: String, replacing_item_name: String)` — заменить предмет.
    - `use_item(item_name: String, used_on_name = null)` — использовать предмет (или применить один предмет к другому).
    - `select_item(item_name: String)` — выбрать предмет.
    - `get_items() -> Array` — получить список всех предметов.
    - `get_selected_item()` — получить выбранный предмет.
    - `get_item_icon(item_name: String)` — получить иконку предмета.
    - `get_item_model(item_name: String)` — получить 3D-модель предмета.

- **Сигналы**:
    - `item_selected(item_name)` — выбран новый предмет.
    - `item_added(item_name)` — предмет добавлен.
    - `item_removed(item_name)` — предмет удалён.
    - `item_replaced(replaced_item_name, replacing_item_name)` — предмет заменён.
    - `item_used(item_name, used_on_name)` — предмет использован.
    - `items_changed(new_items)` — изменился список предметов.

## Как разместить предмет в игровом мире для подбора

Самый простой способ позволить игроку добавить предмет в инвентарь — это разместить его в мире как интерактивный объект. Для этого используется `InteractiveItem`.

1.  **Создайте сцену `InteractiveItem`**:
    *   Унаследуйте новую сцену от `res://addons/goat/main_scenes/InteractiveItem.tscn`.
    *   В качестве дочернего узла добавьте 3D-модель предмета, которую вы ранее создали (например, `MyAwesomeKey.tscn`).
    *   Настройте `CollisionShape3D`, чтобы он соответствовал модели.

2.  **Настройте `InteractiveItem` в инспекторе**:
    *   `Unique Name`: Дайте объекту уникальное имя для сцены (например, `key_on_table`).
    *   `Item Type`: Установите значение `INVENTORY`. Это ключевой шаг.
    *   `Inventory Item Name`: Укажите точное имя предмета, как оно зарегистрировано в системе инвентаря (например, `my_awesome_key`).

Теперь, когда игрок подойдет к этому объекту в игре и нажмет кнопку взаимодействия, `InteractiveItem` будет автоматически удален со сцены, а предмет `my_awesome_key` будет добавлен в `goat_inventory`.

## Продвинутые примеры использования (в коде)

Инвентарь становится по-настоящему мощным, когда вы начинаете взаимодействовать с ним через код, подписываясь на его сигналы.

### Пример 1: Дверь, требующая ключ

Представьте, у вас есть дверь (`InteractiveItem` с `unique_name` = `"locked_door"`), которая должна открываться только если у игрока есть ключ. Чтобы реализовать кастомную логику, нужно унаследовать скрипт от `InteractiveItem.gd` и переопределить его метод `_on_object_activated`.

**Важно:** Правильный способ — переопределение метода.

```gdscript
# Скрипт для двери (LockedDoor.gd)
# 1. Создайте новую сцену, унаследованную от InteractiveItem.tscn.
# 2. Прикрепите к ней этот скрипт.

extends "res://addons/goat/main_scenes/InteractiveItem.gd"

# Переопределяем метод, который вызывается при активации объекта.
func _on_object_activated(object_name, _point):
    # Убедимся, что активирован именно этот объект.
    if object_name != unique_name:
        return

    # Проверяем наличие ключа "my_awesome_key" в инвентаре.
    if goat_inventory.get_items().has("my_awesome_key"):
        print("Дверь открыта!")

        # Удаляем ключ из инвентаря, так как он использован.
        goat_inventory.remove_item("my_awesome_key")

        # Здесь ваша логика открытия двери (анимация, звук, удаление объекта).
        queue_free()
    else:
        print("Дверь заперта. Нужен ключ.")

        # Воспроизводим звук по умолчанию (например, звук "заперто").
        # Звуки настраиваются в инспекторе узла InteractiveItem.
        _play_sound()

        # Показываем игроку сообщение через систему субтитров.
        goat_voice.started.emit("Дверь заперта. Нужен ключ.")

### Пример 2: Использование аптечки для восстановления здоровья

Допустим, у игрока есть предмет `medkit`. При его использовании (двойной клик в инвентаре), здоровье игрока должно восстановиться.

```gdscript
# В каком-нибудь глобальном скрипте или в скрипте игрока (e.g., Player.gd)
func _ready():
    # Подписываемся на глобальный сигнал использования предмета
    goat_inventory.item_used.connect(_on_item_used)

func _on_item_used(item_name, used_on_name):
    # Проверяем, был ли предмет использован сам на себе
    if item_name == used_on_name and item_name == "medkit":
        print("Использована аптечка!")
        # Удаляем аптечку из инвентаря
        goat_inventory.remove_item("medkit")
        # Восстанавливаем здоровье (предполагается, что у вас есть такая переменная)
        # goat_state.player_health += 50 # Если используете goat_state
        print("Здоровье восстановлено!")
```

### Пример 3: Комбинирование предметов

Самый сложный сценарий: игрок в инвентаре перетаскивает один предмет на другой, чтобы создать новый. Например, "пустая бутылка" + "ведро с водой" = "бутылка с водой".

```gdscript
# В каком-нибудь глобальном скрипте (e.g., CraftingManager.gd)
func _ready():
    # Сигнал item_used также отвечает за комбинирование
    goat_inventory.item_used.connect(_on_items_combined)

func _on_items_combined(item_name, used_on_name):
    # Игнорируем, если предмет был использован сам на себе
    if item_name == used_on_name:
        return

    # Наш рецепт: "пустая бутылка" на "ведро с водой"
    if (item_name == "empty_bottle" and used_on_name == "bucket_of_water") or \
       (item_name == "bucket_of_water" and used_on_name == "empty_bottle"):

        print("Создание предмета: Бутылка с водой")

        # Удаляем исходные компоненты
        goat_inventory.remove_item("empty_bottle")
        # goat_inventory.remove_item("bucket_of_water") # Если ведро тоже исчезает

        # Добавляем новый предмет
        goat_inventory.add_item("bottle_with_water")
```

## Работа с UI-инвентарём

- Открытие инвентаря: по умолчанию клавиша `Tab` (`goat_toggle_inventory`).
- В инвентаре можно:
    - Выбрать предмет (клик по иконке)
    - Использовать предмет (двойной клик или кнопка "Использовать")
    - Применить один предмет к другому (перетащить и отпустить на другой предмет)
    - Вращать 3D-модель предмета (зажать ПКМ и двигать мышью)
    - Сбросить вращение (кнопка "Сбросить вращение")
    - Выйти из инвентаря (клавиша `Tab` или `Esc`)

## Пример: добавить ключ в инвентарь через код

```gdscript
# Добавить предмет "key" в инвентарь
if not goat_inventory.get_items().has("key"):
    goat_inventory.add_item("key")
```

## Кастомизация и расширение

- Можно создавать свои UI-сцены, подписываясь на сигналы `goat_inventory`.
- Для сложных предметов реализуйте отдельные 3D-модели и логику использования через обработку сигнала `item_used`.
- Максимальная вместимость инвентаря задаётся константой `CAPACITY` (по умолчанию 8).

*   **Имя предмета**: Уникальный идентификатор предмета в игре.

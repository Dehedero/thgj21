# 3.5. Менеджер диалогов

Менеджер диалогов (`DialogueManager`) — это мощная система для создания, показа и управления нелинейными диалогами с поддержкой условий, ветвлений, мутаций и локализации.

## Архитектура

- **Глобальный синглтон**: `DialogueManager` доступен из любого места проекта.
- **Ресурсы диалогов**: Диалоги хранятся в отдельных ресурсах (`.dialogue`), которые можно создавать и редактировать в редакторе Godot или внешних инструментах.
- **Диалоговые линии**: Каждая реплика, выбор или действие описывается отдельной строкой с уникальным ключом.
- **Сигналы**: Система активно использует сигналы для интеграции с UI и игровыми событиями.

## Как создать и подключить диалог

1. Создайте ресурс диалога (`.dialogue`) в редакторе или вручную.
2. Опишите структуру диалога: реплики, варианты выбора, условия, переходы.
3. Для запуска диалога используйте:

```gdscript
DialogueManager.start_dialogue(load("res://path/to/dialogue.dialogue"))
```

4. Подпишитесь на сигналы для обработки событий:

```gdscript
func _ready():
    DialogueManager.connect("got_dialogue", self._on_got_dialogue)
    DialogueManager.connect("dialogue_ended", self._on_dialogue_ended)

func _on_got_dialogue(line):
    # line.text — текст реплики
    # line.speaker — имя говорящего
    # line.responses — варианты ответа (если есть)
    print(line.text)

func _on_dialogue_ended(resource):
    print("Диалог завершён")
```

## Основные сигналы

- `dialogue_started(resource)` — диалог начат
- `got_dialogue(line)` — получена новая реплика
- `dialogue_ended(resource)` — диалог завершён
- `passed_title(title)` — достигнут заголовок (ветка)
- `mutated(mutation)` — произошла мутация (изменение состояния)

## Ветвления, условия и мутации

- В диалогах можно использовать условия (например, наличие предмета, состояние флага), чтобы показывать разные реплики.
- Мутации позволяют изменять состояние игры прямо из диалога (например, добавить предмет, изменить флаг).

## Пример: запуск диалога при активации объекта

```gdscript
func _on_object_activated(object_name, _point):
    if object_name == "npc_1":
        DialogueManager.start_dialogue(load("res://game/dialogues/npc_1.dialogue"))
```

## Интеграция с goat_voice (Рекомендуемый способ)

Хотя `DialogueManager` можно использовать напрямую для управления нелинейной логикой, для полноценных озвученных диалогов с субтитрами и вариантами ответов рекомендуется использовать его через синглтон `goat_voice`. Эта система выступает в роли "движка", который использует `DialogueManager` под капотом, но добавляет автоматическое воспроизведение звука и интеграцию с UI (`Subtitles.tscn`).

**Основной рабочий процесс:**

1.  **Настройте персонажа в Dialogue Manager**:
    *   В редакторе диалогов (`Dialogue` -> `Characters`) создайте нового персонажа.
    *   В поле `Scene` укажите путь к сцене-прослойке: `res://addons/goat/dialogues/goat_voice_dialogue.tscn`. Эта сцена перенаправляет все вызовы от `DialogueManager` напрямую в синглтон `goat_voice`.

2.  **Свяжите озвучку с репликами**:
    *   В вашем `.dialogue` файле каждая реплика должна иметь уникальный `translation_key`.
    *   Аудиофайл с озвучкой (`.ogg` или `.wav`) должен лежать в `res://game/goat/voice/` и называться **в точности как `translation_key`**. Например, для реплики с ключом `npc_greeting` аудиофайл должен называться `npc_greeting.ogg`.

3.  **Запустите диалог через `goat_voice`**:
    *   Вместо `DialogueManager.start_dialogue()` используйте `goat_voice.start_dialogue()`.

```gdscript
# Пример: Запуск диалога при активации NPC
func _on_object_activated(object_name, _point):
    if object_name == "friendly_npc" and not goat_voice.is_playing():
        # Запускаем диалог. `goat_voice` автоматически:
        # 1. Загрузит мастер-файл `res://game/goat/dialogues/goat.dialogue`.
        # 2. Найдёт реплику с ID "npc_greeting".
        # 3. Найдёт и проиграет аудио `res://game/goat/voice/npc_greeting.ogg`.
        # 4. Пошлёт сигнал для отображения субтитров и вариантов ответа.
        goat_voice.start_dialogue("npc_greeting")
```

При таком подходе `goat_voice` и `Subtitles.tscn` берут на себя всю работу по отображению текста, вариантов ответа и проигрыванию звука, в то время как `DialogueManager` по-прежнему отвечает за логику ветвлений и условий.

Подробнее о возможностях озвучки см. [Работа со звуком и озвучкой](./audio_and_voice.md).

## Кастомизация и расширение

- Можно создавать собственные UI-окна для отображения диалогов, подписываясь на сигналы `DialogueManager`.

Подробнее о Subtitles.tscn см. [Вспомогательные UI-сцены](./helper_scenes.md#subtitles).

- Для сложных сценариев используйте условия, мутации и переходы между ветками.
- Поддерживается локализация и интеграция с глобальными переменными и синглтонами.

# 3.5. Менеджер диалогов

Менеджер диалогов (`DialogueManager`) — это мощная система для создания, показа и управления нелинейными диалогами с поддержкой условий, ветвлений, мутаций и локализации.

## Архитектура

- **Глобальный синглтон**: `DialogueManager` доступен из любого места проекта.
- **Ресурсы диалогов**: Диалоги хранятся в отдельных ресурсах (`.dialogue`), которые можно создавать и редактировать в редакторе Godot или внешних инструментах.
- **Диалоговые линии**: Каждая реплика, выбор или действие описывается отдельной строкой с уникальным ключом.
- **Сигналы**: Система активно использует сигналы для интеграции с UI и игровыми событиями.

## Как создать и подключить диалог

1. Создайте ресурс диалога (`.dialogue`) в редакторе или вручную.
2. Опишите структуру диалога: реплики, варианты выбора, условия, переходы.
3. Для запуска диалога используйте:

```gdscript
DialogueManager.start_dialogue(load("res://path/to/dialogue.dialogue"))
```

4. Подпишитесь на сигналы для обработки событий:

```gdscript
func _ready():
    DialogueManager.connect("got_dialogue", self._on_got_dialogue)
    DialogueManager.connect("dialogue_ended", self._on_dialogue_ended)

func _on_got_dialogue(line):
    # line.text — текст реплики
    # line.speaker — имя говорящего
    # line.responses — варианты ответа (если есть)
    print(line.text)

func _on_dialogue_ended(resource):
    print("Диалог завершён")
```

## Основные сигналы

- `dialogue_started(resource)` — диалог начат
- `got_dialogue(line)` — получена новая реплика
- `dialogue_ended(resource)` — диалог завершён
- `passed_title(title)` — достигнут заголовок (ветка)
- `mutated(mutation)` — произошла мутация (изменение состояния)

## Ветвления, условия и мутации

- В диалогах можно использовать условия (например, наличие предмета, состояние флага), чтобы показывать разные реплики.
- Мутации позволяют изменять состояние игры прямо из диалога (например, добавить предмет, изменить флаг).

## Пример: запуск диалога при активации объекта

```gdscript
func _on_object_activated(object_name, _point):
    if object_name == "npc_1":
        DialogueManager.start_dialogue(load("res://game/dialogues/npc_1.dialogue"))
```

## Кастомизация и расширение

- Можно создавать собственные UI-окна для отображения диалогов, подписываясь на сигналы `DialogueManager`.

Подробнее о Subtitles.tscn см. [Вспомогательные UI-сцены](./helper_scenes.md#subtitles).

- Для сложных сценариев используйте условия, мутации и переходы между ветками.
- Поддерживается локализация и интеграция с глобальными переменными и синглтонами.
